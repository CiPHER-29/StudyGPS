<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study GPS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&display=swap');

        /* Custom font - replace 'YourCustomFont' with your font name and update the src path */
        @font-face {
            font-family: 'YourCustomFont';
            src: url('./your-font-file.woff2') format('woff2'),
                 url('./your-font-file.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            --primary-dark: #0F141A;
            --secondary-dark: #181C1F;
            --tertiary-dark: #232932;
            --accent-blue: #00B7FF;
            --light-blue: #7AC3FF;
            --medium-gray: #AFC2CD;
            --light-gray: #E5EFF7;
            --white: #FCFCFC;
        }

        * {
            box-sizing: border-box;
        }

        body { 
            margin: 0; 
            font-family: 'DM Sans', sans-serif;
            background-color: var(--primary-dark);
            color: var(--light-gray);
        }

        /* Override Tailwind defaults */
        .bg-gradient-to-br {
            background: var(--primary-dark) !important;
        }

        .bg-blue-50 {
            background: var(--primary-dark) !important;
        }

        .from-blue-50 {
            background: var(--primary-dark) !important;
        }

        .to-indigo-100 {
            background: var(--primary-dark) !important;
        }

        .bg-white {
            background-color: var(--primary-dark) !important;
            border: 1px solid var(--tertiary-dark) !important;
        }

        .text-gray-900 {
            color: var(--light-gray) !important;
        }

        .text-gray-600 {
            color: var(--medium-gray) !important;
        }

        .text-gray-800 {
            color: var(--light-gray) !important;
        }

        .text-blue-600 {
            color: var(--accent-blue) !important;
        }

        .bg-blue-600 {
            background-color: var(--accent-blue) !important;
        }

        .bg-blue-100 {
            background-color: rgba(175, 194, 205, 0.2) !important;
        }

        .bg-green-100 {
            background-color: rgba(175, 194, 205, 0.2) !important;
        }

        .bg-purple-100 {
            background-color: rgba(229, 239, 247, 0.2) !important;
        }

        .bg-yellow-100 {
            background-color: rgba(0, 183, 255, 0.2) !important;
        }

        .bg-orange-100 {
            background-color: rgba(175, 194, 205, 0.2) !important;
        }

        .bg-red-100 {
            background-color: rgba(0, 183, 255, 0.2) !important;
        }

        .text-blue-600 {
            color: var(--accent-blue) !important;
        }

        .text-green-600 {
            color: var(--medium-gray) !important;
        }

        .text-purple-600 {
            color: var(--light-gray) !important;
        }

        .text-yellow-700 {
            color: var(--accent-blue) !important;
        }

        .text-yellow-600 {
            color: var(--accent-blue) !important;
        }

        .text-yellow-900 {
            color: var(--accent-blue) !important;
        }

        .text-green-900 {
            color: var(--medium-gray) !important;
        }

        .text-blue-900 {
            color: var(--accent-blue) !important;
        }

        .text-blue-800 {
            color: var(--accent-blue) !important;
        }

        .text-green-800 {
            color: var(--medium-gray) !important;
        }

        .text-orange-600 {
            color: var(--medium-gray) !important;
        }

        .text-red-700 {
            color: var(--accent-blue) !important;
        }

        .hover\:bg-blue-700:hover {
            background-color: rgba(0, 183, 255, 0.85) !important;
        }

        .hover\:bg-gray-100:hover {
            background-color: rgba(175, 194, 205, 0.3) !important;
        }

        .hover\:bg-gray-300:hover {
            background-color: rgba(175, 194, 205, 0.5) !important;
        }

        .bg-gray-200 {
            background-color: var(--medium-gray) !important;
        }

        .border {
            border-color: var(--medium-gray) !important;
        }

        .shadow-sm {
            box-shadow: 0 1px 3px rgba(0, 183, 255, 0.1) !important;
        }

        .focus\:ring-blue-500:focus {
            box-shadow: 0 0 0 2px rgba(0, 183, 255, 0.2) !important;
        }

        .focus\:border-blue-500:focus {
            border-color: var(--accent-blue) !important;
        }

        /* Additional color overrides for proper color scheme */
        .hover\:bg-yellow-200:hover {
            background-color: rgba(0, 183, 255, 0.3) !important;
        }

        .from-green-500, .bg-green-500 {
            background-color: var(--medium-gray) !important;
        }

        .to-green-600, .bg-green-600 {
            background-color: var(--medium-gray) !important;
        }

        .from-purple-500, .bg-purple-500 {
            background-color: var(--light-gray) !important;
        }

        .to-purple-600, .bg-purple-600 {
            background-color: var(--light-gray) !important;
        }

        .from-orange-500, .bg-orange-500 {
            background-color: var(--medium-gray) !important;
        }

        .to-orange-600, .bg-orange-600 {
            background-color: var(--medium-gray) !important;
        }

        .bg-green-50 {
            background-color: rgba(175, 194, 205, 0.1) !important;
        }

        .bg-yellow-50 {
            background-color: rgba(0, 183, 255, 0.1) !important;
        }

        .text-green-100 {
            color: var(--white) !important;
        }

        .text-purple-100 {
            color: var(--white) !important;
        }

        .text-orange-100 {
            color: var(--white) !important;
        }

        .text-yellow-500 {
            color: var(--accent-blue) !important;
        }

        .border-blue-200 {
            border-color: var(--medium-gray) !important;
        }

        .focus\:ring-2:focus {
            box-shadow: 0 0 0 2px rgba(0, 183, 255, 0.2) !important;
        }

        /* Dark theme overrides - remove all white/light backgrounds */
        .bg-black {
            background-color: rgba(15, 20, 26, 0.8) !important;
        }
        .bg-gray-50 {
            background-color: var(--primary-dark) !important;
        }

        .bg-gray-100 {
            background-color: rgba(175, 194, 205, 0.1) !important;
        }

        .bg-indigo-50 {
            background-color: var(--primary-dark) !important;
        }

        /* Text color adjustments for dark theme */
        .text-white {
            color: var(--white) !important;
        }

        .text-black {
            color: var(--light-gray) !important;
        }

        /* Card and modal backgrounds */
        .rounded-lg, .rounded-xl {
            background-color: var(--primary-dark);
            border: 1px solid var(--medium-gray);
        }

        /* Additional background overrides */
        .min-h-screen {
            background: var(--primary-dark) !important;
        }

        /* Remove any remaining light backgrounds */
        div[class*="bg-"] {
            color: var(--light-gray);
        }

        input, textarea, select {
            background-color: var(--primary-dark) !important;
            border-color: var(--medium-gray) !important;
            color: var(--light-gray) !important;
            font-family: 'DM Sans', sans-serif !important;
        }

        input:focus, textarea:focus, select:focus {
            border-color: var(--accent-blue) !important;
            outline: none !important;
            box-shadow: 0 0 0 2px rgba(0, 183, 255, 0.2) !important;
        }

        button {
            font-family: 'DM Sans', sans-serif !important;
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(15, 20, 26, 0.8) !important;
        }

        /* Active timer animation */
        .animate-pulse { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
        }

        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: .5; } 
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--light-gray);
        }

        /* Custom style for selected tab - removed since using inline styles */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // User session management
        const getCurrentUser = () => {
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    return JSON.parse(userData);
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    localStorage.removeItem('userData');
                    localStorage.removeItem('sessionToken');
                    return null;
                }
            }
            return null;
        };

        const logout = () => {
            localStorage.removeItem('userData');
            localStorage.removeItem('sessionToken');
            window.location.href = '/';
        };

        // Icons
        const Plus = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 5v14M5 12h14"/>
            </svg>
        );

        const Clock = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
            </svg>
        );

        const BookOpen = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
            </svg>
        );

        const TrendingUp = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/>
                <polyline points="17,6 23,6 23,12"/>
            </svg>
        );

        const Calendar = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        );

        const Edit = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
        );

        const Trash2 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );

        const Play = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="5,3 19,12 5,21"/>
            </svg>
        );

        const Pause = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
        );

        const Square = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            </svg>
        );

        const BarChart3 = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M3 3v18h18"/>
                <path d="M18 17V9"/>
                <path d="M13 17V5"/>
                <path d="M8 17v-3"/>
            </svg>
        );

        const PieChart = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </svg>
        );

        const Target = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </svg>
        );

        const Activity = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
            </svg>
        );

        const Award = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="8" r="7"/>
                <polyline points="8.21,13.89 7,23 12,20 17,23 15.79,13.88"/>
            </svg>
        );

        const RotateCcw = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="1,4 1,10 7,10"/>
                <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
            </svg>
        );

        // Utility function to convert YouTube URL to embed format
        const getYouTubeEmbedUrl = (url) => {
            if (!url) return null;
            
            // Extract video ID from various YouTube URL formats
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            
            if (match && match[2].length === 11) {
                return `https://www.youtube.com/embed/${match[2]}`;
            }
            
            return null;
        };

        const StudyTracker = () => {
            const [subjects, setSubjects] = useState([]);
            const [studySessions, setStudySessions] = useState([]);
            // Per-subject timer system
            const [timersBySubject, setTimersBySubject] = useState({});
            const [currentlyRunningSubjectId, setCurrentlyRunningSubjectId] = useState(null);
            const [tick, setTick] = useState(0); // For forcing re-renders
            const [currentView, setCurrentView] = useState('dashboard');
            const [showAddSubject, setShowAddSubject] = useState(false);
            const [showAddSession, setShowAddSession] = useState(false);
            const [editingSubject, setEditingSubject] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [videoNotes, setVideoNotes] = useState([]);
            const [showAddVideoNote, setShowAddVideoNote] = useState(false);

            // Initialize user and load data
            useEffect(() => {
                const initializeApp = async () => {
                    const currentUser = getCurrentUser();
                    if (!currentUser) {
                        window.location.href = '/';
                        return;
                    }

                    setUser(currentUser);

                    // Load user's study data
                    try {
                        const response = await fetch(`/api/study-data/${currentUser.userId}`);
                        if (response.ok) {
                            const data = await response.json();
                            setSubjects(data.subjects || []);
                            setStudySessions(data.sessions || []);
                        }
                    } catch (error) {
                        console.error('Error loading study data:', error);
                    }

                    // Load video notes
                    await loadVideoNotes();

                    setLoading(false);
                };

                initializeApp();
            }, []);

            // Helper functions for per-subject timers
            const getTimerKey = (userId) => `study-timers-${userId}`;

            const persistTimers = (timers) => {
                if (user) {
                    localStorage.setItem(getTimerKey(user.userId), JSON.stringify(timers));
                }
            };

            const loadPersistedTimers = () => {
                if (user) {
                    const saved = localStorage.getItem(getTimerKey(user.userId));
                    if (saved) {
                        try {
                            return JSON.parse(saved);
                        } catch (e) {
                            console.error('Error parsing saved timers:', e);
                        }
                    }
                }
                return {};
            };

            const computeDisplayTime = (subjectId) => {
                const timer = timersBySubject[subjectId];
                if (!timer) return 0;

                if (timer.running && timer.startedAt) {
                    return timer.elapsed + Math.floor((Date.now() - timer.startedAt) / 1000);
                }
                return timer.elapsed;
            };

            // Load persisted timers on user change
            useEffect(() => {
                if (user) {
                    const persistedTimers = loadPersistedTimers();
                    setTimersBySubject(persistedTimers);

                    // Find currently running subject
                    const runningSubjectId = Object.keys(persistedTimers).find(id => persistedTimers[id].running);
                    if (runningSubjectId) {
                        setCurrentlyRunningSubjectId(runningSubjectId);
                    }
                }
            }, [user]);

            // Global timer tick effect
            useEffect(() => {
                let interval = null;
                if (currentlyRunningSubjectId) {
                    interval = setInterval(() => {
                        setTick(prev => prev + 1);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [currentlyRunningSubjectId]);

            // Persist timers when they change
            useEffect(() => {
                if (user && Object.keys(timersBySubject).length > 0) {
                    persistTimers(timersBySubject);
                }
            }, [timersBySubject, user]);

            const formatTime = (seconds) => {
                const hours = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const addSubject = async (subjectData) => {
                if (!user) return;

                try {
                    const response = await fetch('/api/subjects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.userId,
                            ...subjectData
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        setSubjects(prev => [...prev, result.subject]);
                        setShowAddSubject(false);
                    } else {
                        console.error('Error adding subject');
                    }
                } catch (error) {
                    console.error('Error adding subject:', error);
                }
            };

            const updateSubject = (id, updatedData) => {
                setSubjects(prev => prev.map(subject => 
                    subject.id === id ? { ...subject, ...updatedData } : subject
                ));
                setEditingSubject(null);
            };

            const deleteSubject = async (id) => {
                if (!user) return;

                if (window.confirm('Are you sure you want to delete this subject? This will also delete all associated sessions and notes.')) {
                    try {
                        const sessionToken = localStorage.getItem('sessionToken');

                        const response = await fetch(`/api/subjects/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Session-Token': sessionToken
                            }
                        });

                        if (response.ok) {
                            setSubjects(prev => prev.filter(subject => subject.id !== id));
                            setStudySessions(prev => prev.filter(session => session.subjectId !== id));
                            setVideoNotes(prev => prev.filter(note => note.subjectId !== id));
                        } else if (response.status === 401) {
                            alert('Your session has expired. Please log in again.');
                            logout();
                        } else if (response.status === 403) {
                            alert('You are not authorized to delete this subject.');
                        } else {
                            alert('Error deleting subject. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error deleting subject:', error);
                        alert('Error deleting subject. Please check your connection.');
                    }
                }
            };

            const deleteSession = async (sessionId) => {
                if (!user) return;

                if (window.confirm('Are you sure you want to delete this study session?')) {
                    try {
                        const sessionToken = localStorage.getItem('sessionToken');

                        const response = await fetch(`/api/sessions/${sessionId}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Session-Token': sessionToken
                            }
                        });

                        if (response.ok) {
                            setStudySessions(prev => prev.filter(session => session.id !== sessionId));
                        } else if (response.status === 401) {
                            alert('Your session has expired. Please log in again.');
                            logout();
                        } else if (response.status === 403) {
                            alert('You are not authorized to delete this session.');
                        } else {
                            alert('Error deleting session. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error deleting session:', error);
                        alert('Error deleting session. Please check your connection.');
                    }
                }
            };

            const startTimer = (subjectId) => {
                if (!subjectId) return;

                // Convert subjectId to string for consistent key handling
                const subjectKey = String(subjectId);

                // If this subject is already running, do nothing
                if (currentlyRunningSubjectId === subjectKey) {
                    return;
                }

                setTimersBySubject(prev => {
                    const updated = { ...prev };

                    // Pause any currently running subject
                    if (currentlyRunningSubjectId && updated[currentlyRunningSubjectId]) {
                        const currentTimer = updated[currentlyRunningSubjectId];
                        if (currentTimer.running && currentTimer.startedAt) {
                            updated[currentlyRunningSubjectId] = {
                                ...currentTimer,
                                elapsed: currentTimer.elapsed + Math.floor((Date.now() - currentTimer.startedAt) / 1000),
                                running: false,
                                startedAt: null,
                                lastSavedElapsed: currentTimer.lastSavedElapsed || 0
                            };
                        }
                    }

                    // Start/resume the requested subject
                    updated[subjectKey] = {
                        elapsed: updated[subjectKey]?.elapsed || 0,
                        running: true,
                        startedAt: Date.now(),
                        lastSavedElapsed: updated[subjectKey]?.lastSavedElapsed || 0
                    };

                    return updated;
                });

                setCurrentlyRunningSubjectId(subjectKey);
            };

            const pauseTimer = (subjectId) => {
                const subjectKey = String(subjectId || currentlyRunningSubjectId);
                if (!subjectKey) return;

                setTimersBySubject(prev => {
                    const updated = { ...prev };
                    const timer = updated[subjectKey];

                    if (timer && timer.running && timer.startedAt) {
                        updated[subjectKey] = {
                            ...timer,
                            elapsed: timer.elapsed + Math.floor((Date.now() - timer.startedAt) / 1000),
                            running: false,
                            startedAt: null,
                            lastSavedElapsed: timer.lastSavedElapsed || 0
                        };
                    }

                    return updated;
                });

                setCurrentlyRunningSubjectId(null);
            };

            const stopTimer = async (subjectId) => {
                const subjectKey = String(subjectId || currentlyRunningSubjectId);
                if (!subjectKey || !user) return;

                const timer = timersBySubject[subjectKey];
                if (!timer) return;

                // Calculate final duration
                const finalDuration = timer.running && timer.startedAt 
                    ? timer.elapsed + Math.floor((Date.now() - timer.startedAt) / 1000)
                    : timer.elapsed;

                // Calculate delta since last save
                const lastSaved = timer.lastSavedElapsed || 0;
                const deltaToSave = finalDuration - lastSaved;

                // Save session if there's actual new time logged
                if (deltaToSave > 0) {
                    try {
                        const response = await fetch('/api/sessions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Session-Token': localStorage.getItem('sessionToken')
                            },
                            body: JSON.stringify({
                                userId: user.userId,
                                subjectId: String(subjectKey),
                                duration: deltaToSave,
                                date: new Date().toISOString().split('T')[0],
                                timestamp: new Date().toISOString()
                            }),
                        });

                        if (response.ok) {
                            const result = await response.json();
                            setStudySessions(prev => [...prev, result.session]);
                        } else {
                            console.error('Error saving session');
                        }
                    } catch (error) {
                        console.error('Error saving session:', error);
                    }
                }

                // Keep timer with elapsed time, just stop it
                setTimersBySubject(prev => {
                    const updated = { ...prev };
                    updated[subjectKey] = {
                        elapsed: finalDuration,
                        running: false,
                        startedAt: null,
                        lastSavedElapsed: finalDuration
                    };
                    return updated;
                });

                // Always clear the currently running subject ID when stopping this subject
                if (currentlyRunningSubjectId === subjectKey) {
                    setCurrentlyRunningSubjectId(null);
                }

            };

            const resetTimer = (subjectId) => {
                const subjectKey = String(subjectId);
                if (!subjectKey) return;

                // Stop the timer if it's currently running
                if (currentlyRunningSubjectId === subjectKey) {
                    setCurrentlyRunningSubjectId(null);
                }

                // Reset the timer to 0
                setTimersBySubject(prev => {
                    const updated = { ...prev };
                    delete updated[subjectKey];
                    return updated;
                });

                // Persist the change
                const updatedTimers = { ...timersBySubject };
                delete updatedTimers[subjectKey];
                persistTimers(updatedTimers);
            };

            const resetSubjectProgress = async (subjectId) => {
                if (!user) return;

                const subject = subjects.find(s => String(s.id) === String(subjectId));
                const subjectName = subject ? subject.name : 'this subject';

                if (!confirm(`Are you sure you want to reset all progress for ${subjectName}? This will delete all study sessions and reset the timer. This action cannot be undone.`)) {
                    return;
                }

                try {
                    // First reset the timer automatically
                    resetTimer(subjectId);

                    // Get all sessions for this subject
                    const subjectSessions = studySessions.filter(session => String(session.subjectId) === String(subjectId));

                    // Get session token from localStorage (correct way)
                    const sessionToken = localStorage.getItem('sessionToken');

                    // Delete all sessions in parallel for better performance
                    const deletePromises = subjectSessions.map(session => 
                        fetch(`/api/sessions/${session.id}`, {
                            method: 'DELETE',
                            headers: {
                                'X-Session-Token': sessionToken
                            }
                        })
                    );

                    const deleteResults = await Promise.all(deletePromises);

                    // Check if all deletes were successful
                    const failedDeletes = deleteResults.filter(response => !response.ok);

                    if (failedDeletes.length > 0) {
                        console.error(`Failed to delete ${failedDeletes.length} session(s)`);
                        alert(`Warning: ${failedDeletes.length} session(s) could not be deleted from the server. Some data may reappear after refresh.`);
                    }

                    // Update local state by removing all sessions for this subject
                    setStudySessions(prev => prev.filter(session => String(session.subjectId) !== String(subjectId)));

                    // Only show success if all deletes succeeded
                    if (failedDeletes.length === 0) {
                        alert(`All progress for ${subjectName} has been reset successfully!`);
                    }

                } catch (error) {
                    console.error('Error resetting subject progress:', error);
                    alert('There was an error resetting the subject progress. Please try again.');
                }
            };

            const addSession = async (sessionData) => {
                if (!user) return;

                try {
                    const response = await fetch('/api/sessions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.userId,
                            subjectId: String(sessionData.subjectId), // Keep subjectId as string
                            duration: sessionData.hours * 3600 + sessionData.minutes * 60,
                            date: sessionData.date,
                            timestamp: new Date().toISOString() // Add timestamp for sorting
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        setStudySessions(prev => [...prev, result.session]);
                        setShowAddSession(false);
                    } else {
                        console.error('Error adding session');
                    }
                } catch (error) {
                    console.error('Error adding session:', error);
                }
            };

            const addVideoNote = async (noteData) => {
                if (!user) return;

                try {
                    const response = await fetch('/api/video-notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.userId,
                            title: noteData.title,
                            content: noteData.content,
                            videoUrl: noteData.videoUrl || null,
                            subjectId: noteData.subjectId === '' ? null : String(noteData.subjectId) // Handle empty subjectId and keep as string
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Fetch associated subject data if subjectId is provided
                        let subject = null;
                        if (noteData.subjectId !== '') {
                            subject = subjects.find(s => s.id === parseInt(noteData.subjectId));
                        }
                        setVideoNotes(prev => [...prev, { ...result.note, subject }]);
                        setShowAddVideoNote(false);
                    } else {
                        console.error('Error adding video note');
                    }
                } catch (error) {
                    console.error('Error adding video note:', error);
                }
            };

            const loadVideoNotes = async () => {
                if (!user) return;

                try {
                    const response = await fetch(`/api/video-notes/${user.userId}`);
                    if (response.ok) {
                        const result = await response.json();
                        // Enrich notes with subject data
                        const enrichedNotes = result.notes.map(note => {
                            let subject = null;
                            if (note.subjectId) {
                                subject = subjects.find(s => s.id === note.subjectId);
                            }
                            return { ...note, subject };
                        });
                        setVideoNotes(enrichedNotes);
                    }
                } catch (error) {
                    console.error('Error loading video notes:', error);
                }
            };

            const deleteVideoNote = async (noteId) => {
                if (!user) return;

                try {
                    const response = await fetch(`/api/video-notes/${noteId}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        setVideoNotes(prev => prev.filter(note => note.id !== noteId));
                    } else {
                        console.error('Error deleting video note');
                    }
                } catch (error) {
                    console.error('Error deleting video note:', error);
                }
            };

            const getSubjectStats = (subjectId) => {
                const sessions = studySessions.filter(s => String(s.subjectId) === String(subjectId));
                const totalTime = sessions.reduce((sum, s) => sum + s.duration, 0);
                const sessionsToday = sessions.filter(s => s.date === new Date().toISOString().split('T')[0]).length;
                const totalSessions = sessions.length;

                return { totalTime, sessionsToday, totalSessions };
            };

            const getOverallStats = () => {
                const totalTime = studySessions.reduce((sum, s) => sum + s.duration, 0);
                const today = new Date().toISOString().split('T')[0];
                const timeToday = studySessions.filter(s => s.date === today).reduce((sum, s) => sum + s.duration, 0);
                const sessionsToday = studySessions.filter(s => s.date === today).length;

                return { totalTime, timeToday, sessionsToday };
            };

            const SubjectForm = ({ subject, onSubmit, onCancel }) => {
                const [formData, setFormData] = useState({
                    name: subject?.name || '',
                    color: subject?.color || '#C20114',
                    goal: subject?.goal || 60,
                    description: subject?.description || ''
                });

                const colorOptions = [
                    { value: '#FF6B6B', name: 'Red' },
                    { value: '#FF8E53', name: 'Orange' },
                    { value: '#FFD700', name: 'Yellow' },
                    { value: '#66BB6A', name: 'Green' },
                    { value: '#42A5F5', name: 'Blue' },
                    { value: '#5C6BC0', name: 'Indigo' },
                    { value: '#AB47BC', name: 'Purple' },
                    { value: '#7E57C2', name: 'Deep Purple' },
                    { value: '#EC407A', name: 'Hot Pink' },
                    { value: '#8BC34A', name: 'Light Green' },
                    { value: '#00ACC1', name: 'Cyan' },
                    { value: '#29B6F6', name: 'Light Blue' },
                    { value: '#9C27B0', name: 'Violet' },
                    { value: '#673AB7', name: 'Dark Violet' },
                    { value: '#E91E63', name: 'Magenta' },
                    { value: '#4CAF50', name: 'Forest Green' },
                    { value: '#009688', name: 'Dark Teal' },
                    { value: '#03A9F4', name: 'Sky Blue' },
                    { value: '#3F51B5', name: 'Navy Blue' },
                    { value: '#9E9E9E', name: 'Gray' },
                    { value: '#607D8B', name: 'Blue Gray' },
                    { value: '#795548', name: 'Brown' },
                    { value: '#FF5722', name: 'Deep Orange' },
                    { value: '#CDDC39', name: 'Lime' },
                    { value: '#FFC107', name: 'Gold' },
                    { value: '#FF9800', name: 'Orange Gold' }
                ];

                const handleSubmit = () => {
                    if (formData.name.trim()) {
                        onSubmit(formData);
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-xl font-bold mb-4">{subject ? 'Edit Subject' : 'Add New Subject'}</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Subject Name</label>
                                    <input
                                        type="text"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Color</label>
                                    <div className="space-y-3">
                                        {/* Selected Color Display */}
                                        <div className="flex items-center gap-3">
                                            <div 
                                                className="w-12 h-12 rounded-lg border-2 border-gray-300"
                                                style={{ backgroundColor: formData.color }}
                                            ></div>
                                            <input
                                                type="text"
                                                value={formData.color}
                                                onChange={(e) => setFormData({...formData, color: e.target.value})}
                                                className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                placeholder="#FF0000"
                                            />
                                        </div>

                                        {/* Color Palette Grid */}
                                        <div className="grid grid-cols-6 gap-2">
                                            {['#FF0000', '#FF8C00', '#FFD700', '#32CD32', '#0080FF', '#8A2BE2', '#FF1493', '#808080', '#000000', '#FFFFFF', '#795548', '#009688'].map(color => (
                                                <div
                                                    key={color}
                                                    className={`w-8 h-8 rounded cursor-pointer border-2 transition-all hover:scale-110 ${
                                                        formData.color === color ? 'border-white ring-2 ring-blue-500' : 'border-gray-300'
                                                    }`}
                                                    style={{ backgroundColor: color }}
                                                    onClick={() => setFormData({...formData, color: color})}
                                                />
                                            ))}
                                        </div>

                                        {/* HTML5 Color Input */}
                                        <div className="flex items-center gap-3 p-3 bg-gray-100 rounded-lg">
                                            <input
                                                type="color"
                                                value={formData.color}
                                                onChange={(e) => setFormData({...formData, color: e.target.value})}
                                                className="w-20 h-12 rounded-lg border-2 border-gray-400 cursor-pointer shadow-sm"
                                                title="Open color picker for custom colors"
                                            />
                                            <div className="flex-1">
                                                <div className="text-sm font-medium text-gray-700">Custom Color Picker</div>
                                                <div className="text-xs text-gray-500">Click to open your browser's color picker</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Daily Goal (minutes)</label>
                                    <input
                                        type="number"
                                        value={formData.goal}
                                        onChange={(e) => setFormData({...formData, goal: parseInt(e.target.value)})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        min="1"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Description (optional)</label>
                                    <textarea
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="3"
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSubmit}
                                        className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        {subject ? 'Update' : 'Add'} Subject
                                    </button>
                                    <button
                                        onClick={onCancel}
                                        className="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const SessionForm = ({ onSubmit, onCancel }) => {
                const [formData, setFormData] = useState({
                    subjectName: '',
                    date: new Date().toISOString().split('T')[0],
                    hours: 0,
                    minutes: 30
                });

                const handleSubmit = async () => {
                    if ((formData.hours > 0 || formData.minutes > 0) && formData.subjectName.trim()) {
                        // Check if subject already exists
                        let existingSubject = subjects.find(s => s.name.toLowerCase() === formData.subjectName.trim().toLowerCase());

                        if (!existingSubject) {
                            // Create new subject automatically
                            const newSubjectData = {
                                name: formData.subjectName.trim(),
                                color: '#' + Math.floor(Math.random()*16777215).toString(16), // Random color
                                goal: 60, // Default 1 hour goal
                                description: `Auto-created for session on ${formData.date}`
                            };

                            try {
                                const sessionToken = localStorage.getItem('sessionToken');
                                const response = await fetch('/api/subjects', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-Session-Token': sessionToken
                                    },
                                    body: JSON.stringify({
                                        userId: user.userId,
                                        ...newSubjectData
                                    }),
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    existingSubject = result.subject;
                                    setSubjects(prev => [...prev, result.subject]);
                                }
                            } catch (error) {
                                console.error('Error creating subject:', error);
                                alert('Error creating subject. Please try again.');
                                return;
                            }
                        }

                        if (existingSubject) {
                            onSubmit({
                                subjectId: existingSubject.id.toString(),
                                date: formData.date,
                                hours: formData.hours,
                                minutes: formData.minutes
                            });
                        }
                    }
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white rounded-xl p-6 w-full max-w-md">
                            <h3 className="text-xl font-bold mb-4">Add Study Session</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Subject Name</label>
                                    <input
                                        type="text"
                                        value={formData.subjectName}
                                        onChange={(e) => setFormData({...formData, subjectName: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter subject name (will create new if doesn't exist)"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Date</label>
                                    <input
                                        type="date"
                                        value={formData.date}
                                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Hours</label>
                                        <input
                                            type="number"
                                            value={formData.hours}
                                            onChange={(e) => setFormData({...formData, hours: parseInt(e.target.value) || 0})}
                                            className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            min="0"
                                            max="12"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">Minutes</label>
                                        <input
                                            type="number"
                                            value={formData.minutes}
                                            onChange={(e) => setFormData({...formData, minutes: parseInt(e.target.value) || 0})}
                                            className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                            min="0"
                                            max="59"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSubmit}
                                        className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Add Session
                                    </button>
                                    <button
                                        onClick={onCancel}
                                        className="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const VideoNoteForm = ({onSubmit, onCancel }) => {
                const [formData, setFormData] = useState({
                    title: '',
                    content: '',
                    videoUrl: '',
                    subjectName: ''
                });

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!formData.title || !formData.videoUrl) {
                        alert('Please fill in both title and video URL');
                        return;
                    }

                    let finalSubjectId = null;

                    // If subject name is provided, find or create the subject
                    if (formData.subjectName.trim()) {
                        let existingSubject = subjects.find(s => s.name.toLowerCase() === formData.subjectName.trim().toLowerCase());

                        if (!existingSubject) {
                            // Create new subject automatically
                            const newSubjectData = {
                                name: formData.subjectName.trim(),
                                color: '#' + Math.floor(Math.random()*16777215).toString(16), // Random color
                                goal: 60, // Default 1 hour goal
                                description: `Auto-created for video note: ${formData.title}`
                            };

                            try {
                                const sessionToken = localStorage.getItem('sessionToken');
                                const response = await fetch('/api/subjects', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-Session-Token': sessionToken
                                    },
                                    body: JSON.stringify({
                                        userId: user.userId,
                                        ...newSubjectData
                                    }),
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    existingSubject = result.subject;
                                    setSubjects(prev => [...prev, result.subject]);
                                }
                            } catch (error) {
                                console.error('Error creating subject:', error);
                                alert('Error creating subject. Please try again.');
                                return;
                            }
                        }

                        if (existingSubject) {
                            finalSubjectId = existingSubject.id.toString();
                        }
                    }

                    onSubmit({
                        title: formData.title,
                        content: formData.content,
                        videoUrl: formData.videoUrl,
                        subjectId: finalSubjectId || ''
                    });
                    setFormData({ title: '', content: '', videoUrl: '', subjectName: '' }); // Reset form
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div className="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
                            <h3 className="text-xl font-bold mb-4">Add Video Note</h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Title</label>
                                    <input
                                        type="text"
                                        value={formData.title}
                                        onChange={(e) => setFormData({...formData, title: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter note title"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">YouTube Video URL *</label>
                                    <input
                                        type="url"
                                        value={formData.videoUrl}
                                        onChange={(e) => setFormData({...formData, videoUrl: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="https://www.youtube.com/watch?v=..."
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Content (optional)</label>
                                    <textarea
                                        value={formData.content}
                                        onChange={(e) => setFormData({...formData, content: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        rows="4"
                                        placeholder="Enter your notes here..."
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Subject Name (optional)</label>
                                    <input
                                        type="text"
                                        value={formData.subjectName}
                                        onChange={(e) => setFormData({...formData, subjectName: e.target.value})}
                                        className="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="Enter subject name (will create new if doesn't exist)"
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSubmit}
                                        className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
                                    >
                                        Add Note
                                    </button>
                                    <button
                                        onClick={onCancel}
                                        className="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const overallStats = getOverallStats();

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-pulse">
                                <div className="h-8 bg-gray-300 rounded w-48 mx-auto mb-4"></div>
                                <div className="h-4 bg-gray-200 rounded w-32 mx-auto"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    <div className="container mx-auto px-4 py-8 max-w-7xl">
                        <div className="mb-8 flex justify-between items-center">
                            <div className="flex items-center gap-6">
                                <div>
                                    <h1 className="text-6xl font-bold" style={{letterSpacing: '-0.08em'}}>
                                        <span className="text-white">Study</span>
                                        <span className="text-blue-600">GPS</span>
                                    </h1>
                                </div>
                                {/* Calendar Widget */}
                                <div className="bg-blue-50 rounded-lg p-2 border border-blue-200">
                                    <div className="flex items-center gap-2 text-center">
                                        <div className="text-white text-sm font-bold">
                                            {new Date().toLocaleDateString('en-US', { month: 'short' })}
                                        </div>
                                        <div className="text-white font-bold text-lg">
                                            {new Date().getDate()}
                                        </div>
                                        <div className="text-blue-600 font-bold text-sm">
                                            {new Date().toLocaleDateString('en-US', { weekday: 'short' })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4 ml-8">
                                <span className="text-white">Welcome, {user?.name || user?.email}</span>
                                <button 
                                    onClick={logout}
                                    className="px-4 py-2 border-2 border-blue-600 bg-transparent text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition-colors"
                                >
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm mb-6">
                            <div className="flex flex-wrap gap-1 p-2">
                                {['dashboard', 'subjects', 'analytics', 'video-notes'].map((view) => (
                                    <button
                                        key={view}
                                        onClick={() => setCurrentView(view)}
                                        className={`px-4 py-2 rounded-lg font-medium transition-colors capitalize ${
                                            currentView === view 
                                                ? 'bg-blue-600 text-white' 
                                                : 'bg-gray-200 hover:bg-gray-300'
                                        }`}
                                        style={{
                                            color: currentView === view ? 'white' : 'black'
                                        }}
                                    >
                                        {view}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* Global TimerBar - visible across all sections */}
                        {(currentlyRunningSubjectId || Object.keys(timersBySubject).length > 0) && (
                            <div className="bg-white rounded-xl shadow-sm p-4 mb-6 border-l-4 border-blue-600">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                        <div className="p-2 bg-blue-100 rounded-lg">
                                            <Clock className="w-5 h-5 text-blue-600" />
                                        </div>
                                        <div className="flex items-center gap-6">
                                            {currentlyRunningSubjectId && (
                                                <div className="flex items-center gap-2">
                                                    <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                                    <div>
                                                        <p className="text-sm text-gray-600">Currently studying</p>
                                                        <p className="font-bold text-gray-900">
                                                            {subjects.find(s => String(s.id) === currentlyRunningSubjectId)?.name || 'Unknown Subject'} - {formatTime(computeDisplayTime(currentlyRunningSubjectId))}
                                                        </p>
                                                    </div>
                                                </div>
                                            )}
                                            {Object.entries(timersBySubject).filter(([id]) => id !== currentlyRunningSubjectId && timersBySubject[id].elapsed > 0).map(([subjectId, timer]) => (
                                                <div key={subjectId} className="flex items-center gap-2">
                                                    <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                                    <div>
                                                        <p className="text-xs text-white">Paused</p>
                                                        <p className="text-sm font-medium text-white">
                                                            {subjects.find(s => String(s.id) === subjectId)?.name || 'Unknown Subject'} - {formatTime(timer.elapsed)}
                                                        </p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        {currentlyRunningSubjectId && (
                                            <>
                                                <button
                                                    onClick={() => pauseTimer(currentlyRunningSubjectId)}
                                                    className="p-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors"
                                                    title="Pause Timer"
                                                >
                                                    <Pause className="w-4 h-4" />
                                                </button>
                                                <button
                                                    onClick={() => stopTimer(currentlyRunningSubjectId)}
                                                    className="p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors"
                                                    title="Stop and Save Session"
                                                >
                                                    <Square className="w-4 h-4" />
                                                </button>
                                                <button
                                                    onClick={() => resetTimer(currentlyRunningSubjectId)}
                                                    className="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                                                    title="Reset Timer to 0"
                                                >
                                                    <RotateCcw className="w-4 h-4" />
                                                </button>
                                            </>
                                        )}
                                        {/* Show reset buttons for paused timers when no timer is currently running */}
                                        {!currentlyRunningSubjectId && Object.keys(timersBySubject).length > 0 && (
                                            <div className="flex gap-2">
                                                {Object.entries(timersBySubject).filter(([id, timer]) => timer.elapsed > 0).map(([subjectId, timer]) => (
                                                    <button
                                                        key={subjectId}
                                                        onClick={() => resetTimer(subjectId)}
                                                        className="p-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors"
                                                        title={`Reset ${subjects.find(s => String(s.id) === subjectId)?.name || 'Unknown'} Timer to 0`}
                                                    >
                                                        <RotateCcw className="w-4 h-4" />
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {currentView === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid md:grid-cols-3 gap-6">
                                    <div className="bg-white rounded-xl p-6 shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <div className="p-3 bg-blue-100 rounded-lg">
                                                <Clock className="w-6 h-6 text-blue-600" />
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Today's Study Time</p>
                                                <p className="text-2xl font-bold text-gray-900">
                                                    {Math.floor(overallStats.timeToday / 3600)}h {Math.floor((overallStats.timeToday % 3600) / 60)}m
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl p-6 shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <div className="p-3 bg-green-100 rounded-lg">
                                                <BookOpen className="w-6 h-6 text-green-600" />
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Sessions Today</p>
                                                <p className="text-2xl font-bold text-gray-900">{overallStats.sessionsToday}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-xl p-6 shadow-sm">
                                        <div className="flex items-center gap-3">
                                            <div className="p-3 bg-purple-100 rounded-lg">
                                                <TrendingUp className="w-6 h-6 text-purple-600" />
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-600">Total Study Time</p>
                                                <p className="text-2xl font-bold text-gray-900">
                                                    {Math.floor(overallStats.totalTime / 3600)}h {Math.floor((overallStats.totalTime % 3600) / 60)}m
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-xl font-semibold">Your Subjects</h2>
                                        <button
                                            onClick={() => setShowAddSubject(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            <Plus className="w-4 h-4" />
                                            Add Subject
                                        </button>
                                    </div>

                                    {subjects.length === 0 ? (
                                        <div className="text-center py-12">
                                            <BookOpen className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                            <p className="text-gray-500 mb-4">No subjects added yet</p>
                                            <button
                                                onClick={() => setShowAddSubject(true)}
                                                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                            >
                                                Add Your First Subject
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {subjects.map(subject => {
                                                const stats = getSubjectStats(subject.id);
                                                const goalProgress = (stats.totalTime / (subject.goal * 60)) * 100;

                                                return (
                                                    <div key={subject.id} className="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                                        <div className="flex items-center gap-3 mb-3">
                                                            <div 
                                                                className="w-4 h-4 rounded-full"
                                                                style={{ backgroundColor: subject.color }}
                                                            ></div>
                                                            <h3 className="font-semibold flex-1">{subject.name}</h3>

                                                                <button
                                                                    onClick={() => startTimer(subject.id)}
                                                                    className="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                                                                    title={currentlyRunningSubjectId === String(subject.id) ? "Running" : (timersBySubject[String(subject.id)]?.elapsed > 0 ? "Resume Timer" : "Start Timer")}
                                                                >
                                                                    <Play className="w-4 h-4" />
                                                                </button>
                                                        </div>
                                                        <div className="space-y-2">
                                                            <div className="flex justify-between text-sm">
                                                                <span>Today's Goal</span>
                                                                <span>{Math.floor(stats.totalTime / 60)}/{subject.goal} min</span>
                                                            </div>
                                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                                <div 
                                                                    className="bg-blue-600 h-2 rounded-full transition-all"
                                                                    style={{ width: `${Math.min(goalProgress, 100)}%` }}
                                                                ></div>
                                                            </div>
                                                            <p className="text-xs text-gray-500">
                                                                {stats.totalSessions} sessions • {Math.floor(stats.totalTime / 3600)}h {Math.floor((stats.totalTime % 3600) / 60)}m total
                                                            </p>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentView === 'subjects' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-900">Subject Management</h2>
                                            <p className="text-gray-600">Manage your study subjects and their goals</p>
                                        </div>
                                        <button
                                            onClick={() => setShowAddSubject(true)}
                                            className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                        >
                                            <Plus className="w-4 h-4" />
                                            Add New Subject
                                        </button>
                                    </div>

                                    {subjects.length === 0 ? (
                                        <div className="text-center py-20">
                                            <BookOpen className="w-20 h-20 text-gray-300 mx-auto mb-4" />
                                            <h3 className="text-xl font-semibold text-gray-700 mb-2">No subjects yet</h3>
                                            <p className="text-gray-500 mb-6">Start by adding your first study subject</p>
                                            <button
                                                onClick={() => setShowAddSubject(true)}
                                                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                            >
                                                Add Your First Subject
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="grid gap-6">
                                            {subjects.map(subject => {
                                                const stats = getSubjectStats(subject.id);
                                                const goalProgress = (stats.totalTime / (subject.goal * 60)) * 100;
                                                const todayStudied = studySessions.filter(s => 
                                                    String(s.subjectId) === String(subject.id) && 
                                                    s.date === new Date().toISOString().split('T')[0]
                                                ).reduce((sum, s) => sum + s.duration, 0);

                                                return (
                                                    <div key={subject.id} className="border rounded-xl p-6 hover:shadow-lg transition-all duration-200">
                                                        <div className="flex items-start justify-between mb-4">
                                                            <div className="flex items-center gap-4">
                                                                <div 
                                                                    className="w-12 h-12 rounded-xl flex items-center justify-center text-white text-xl font-bold"
                                                                    style={{ backgroundColor: subject.color }}
                                                                >
                                                                    {subject.name.charAt(0).toUpperCase()}
                                                                </div>
                                                                <div>
                                                                    <h3 className="text-xl font-bold text-gray-900">{subject.name}</h3>
                                                                    <p className="text-gray-600">{subject.description || 'No description'}</p>
                                                                    <div className="flex items-center gap-4 mt-2 text-sm text-gray-500">
                                                                        <span>Daily Goal: {subject.goal} minutes</span>
                                                                        <span>•</span>
                                                                        <span>{stats.totalSessions} total sessions</span>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div className="flex items-center gap-2">
                                                                {/* Enhanced individual subject timer cards */}
                                                                <div className="bg-blue-50 rounded-lg p-3 min-w-[200px] border-2" style={{
                                                                    borderColor: currentlyRunningSubjectId === String(subject.id) ? '#10b981' : '#e5e7eb'
                                                                }}>
                                                                    <div className="flex items-center justify-between">
                                                                        <div className="flex items-center gap-2">
                                                                            <div className={`w-3 h-3 rounded-full ${
                                                                                currentlyRunningSubjectId === String(subject.id) 
                                                                                    ? 'bg-green-500 animate-pulse' 
                                                                                    : timersBySubject[String(subject.id)] 
                                                                                        ? 'bg-yellow-500' 
                                                                                        : 'bg-gray-300'
                                                                            }`}></div>
                                                                            <span className="text-lg font-mono font-bold text-blue-700">
                                                                                {formatTime(computeDisplayTime(subject.id))}
                                                                            </span>
                                                                        </div>
                                                                        <div className="flex items-center gap-1">
                                                                            {currentlyRunningSubjectId === String(subject.id) ? (
                                                                                <button
                                                                                    onClick={() => pauseTimer(subject.id)}
                                                                                    className="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs transition-colors"
                                                                                    title="Pause Timer"
                                                                                >
                                                                                    ⏸
                                                                                </button>
                                                                            ) : (
                                                                                <button
                                                                                    onClick={() => startTimer(subject.id)}
                                                                                    className="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs transition-colors"
                                                                                    title="Start Timer"
                                                                                >
                                                                                    ▶
                                                                                </button>
                                                                            )}
                                                                            {timersBySubject[String(subject.id)] && (
                                                                                <>
                                                                                    <button
                                                                                        onClick={() => stopTimer(subject.id)}
                                                                                        className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors ml-1"
                                                                                        title="Stop Timer and Save Session"
                                                                                    >
                                                                                        ⏹
                                                                                    </button>
                                                                                    <button
                                                                                        onClick={() => resetTimer(subject.id)}
                                                                                        className="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs transition-colors ml-1"
                                                                                        title="Reset Timer to 0"
                                                                                    >
                                                                                        🔄
                                                                                    </button>
                                                                                </>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                    <div className="text-xs text-gray-600 mt-2">
                                                                        {currentlyRunningSubjectId === String(subject.id) 
                                                                            ? '🏃 Running - Focus on this subject!' 
                                                                            : timersBySubject[String(subject.id)] 
                                                                                ? '⏸ Paused - Click ▶ to resume'
                                                                                : '⭕ Ready - Click ▶ to start studying'
                                                                        }
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => setEditingSubject(subject)}
                                                                    className="p-3 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors"
                                                                    title="Edit Subject"
                                                                >
                                                                    <Edit className="w-5 h-5" />
                                                                </button>
                                                                <button
                                                                    onClick={() => resetSubjectProgress(subject.id)}
                                                                    className="p-3 bg-orange-100 text-orange-700 rounded-lg hover:bg-orange-200 transition-colors"
                                                                    title="Reset All Progress (Timer + Sessions)"
                                                                >
                                                                    <RotateCcw className="w-5 h-5" />
                                                                </button>
                                                                <button
                                                                    onClick={() => deleteSubject(subject.id)}
                                                                    className="p-3 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors"
                                                                    title="Delete Subject"
                                                                >
                                                                    <Trash2 className="w-5 h-5" />
                                                                </button>
                                                            </div>
                                                        </div>

                                                        <div className="grid md:grid-cols-3 gap-4 mb-4">
                                                            <div className="bg-blue-600 rounded-lg p-4">
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <Clock className="w-4 h-4 text-white" />
                                                                    <span className="text-sm font-medium text-white">Today</span>
                                                                </div>
                                                                <p className="text-2xl font-bold text-white">
                                                                    {Math.floor(todayStudied / 3600)}h {Math.floor((todayStudied % 3600) / 60)}m
                                                                </p>
                                                            </div>

                                                            <div className="bg-blue-600 rounded-lg p-4">
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <TrendingUp className="w-4 h-4 text-white" />
                                                                    <span className="text-sm font-medium text-white">Total Time</span>
                                                                </div>
                                                                <p className="text-2xl font-bold text-white">
                                                                    {Math.floor(stats.totalTime / 3600)}h {Math.floor((stats.totalTime % 3600) / 60)}m
                                                                </p>
                                                            </div>

                                                            <div className="bg-blue-600 rounded-lg p-4">
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <Target className="w-4 h-4 text-white" />
                                                                    <span className="text-sm font-medium text-white">Goal Progress</span>
                                                                </div>
                                                                <p className="text-2xl font-bold text-white">
                                                                    {Math.round(goalProgress)}%
                                                                </p>
                                                            </div>
                                                        </div>

                                                        <div className="space-y-2">
                                                            <div className="flex justify-between text-sm text-gray-600">
                                                                <span>Daily Goal Progress</span>
                                                                <span>{Math.floor(todayStudied / 60)}/{subject.goal} minutes</span>
                                                            </div>
                                                            <div className="w-full bg-gray-200 rounded-full h-3">
                                                                <div 
                                                                    className="h-3 rounded-full transition-all duration-500"
                                                                    style={{ 
                                                                        width: `${Math.min((todayStudied / (subject.goal * 60)) * 100, 100)}%`,
                                                                        backgroundColor: subject.color 
                                                                    }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}



                        {currentView === 'analytics' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-900">Analytics Dashboard</h2>
                                        </div>
                                    </div>

                                    {subjects.length === 0 || studySessions.length === 0 ? (
                                        <div className="text-center py-20">
                                            <BarChart3 className="w-20 h-20 text-gray-300 mx-auto mb-4" />
                                            <h3 className="text-xl font-semibold text-gray-700 mb-2">No data to analyze</h3>
                                            <p className="text-gray-500 mb-6">Add subjects and record study sessions to see your analytics</p>
                                            <div className="flex gap-3 justify-center">
                                                <button
                                                    onClick={() => setCurrentView('subjects')}
                                                    className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                                >
                                                    Add Subjects
                                                </button>
                                                <button
                                                    onClick={() => setCurrentView('sessions')}
                                                    className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                                    disabled={subjects.length === 0}
                                                >
                                                    Record Sessions
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Key Performance Indicators */}
                                            <div className="grid md:grid-cols-4 gap-6 mb-8">
                                                <div className="bg-gray-200 rounded-xl p-6 border border-gray-300" style={{color: 'black'}}>
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                            <Clock className="w-8 h-8" style={{color: 'black'}} />
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-semibold" style={{color: 'black'}}>Total Study Time</h3>
                                                            <p style={{color: 'black'}}>All subjects</p>
                                                        </div>
                                                    </div>
                                                    <p className="text-3xl font-bold" style={{color: 'black'}}>
                                                        {Math.floor(studySessions.reduce((sum, s) => sum + s.duration, 0) / 3600)}h {Math.floor((studySessions.reduce((sum, s) => sum + s.duration, 0) % 3600) / 60)}m
                                                    </p>
                                                </div>

                                                <div className="bg-gray-200 rounded-xl p-6 border border-gray-300" style={{color: 'black'}}>
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                            <Calendar className="w-8 h-8" style={{color: 'black'}} />
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-semibold" style={{color: 'black'}}>Study Days</h3>
                                                            <p style={{color: 'black'}}>Unique dates</p>
                                                        </div>
                                                    </div>
                                                    <p className="text-3xl font-bold" style={{color: 'black'}}>
                                                        {[...new Set(studySessions.map(s => s.date))].length}
                                                    </p>
                                                </div>

                                                <div className="bg-gray-200 rounded-xl p-6 border border-gray-300" style={{color: 'black'}}>
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                            <Target className="w-8 h-8" style={{color: 'black'}} />
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-semibold" style={{color: 'black'}}>Average Session</h3>
                                                            <p style={{color: 'black'}}>Per study</p>
                                                        </div>
                                                    </div>
                                                    <p className="text-3xl font-bold" style={{color: 'black'}}>
                                                        {studySessions.length > 0 ? Math.round(studySessions.reduce((sum, s) => sum + s.duration, 0) / studySessions.length / 60) : 0} min
                                                    </p>
                                                </div>

                                                <div className="bg-gray-200 rounded-xl p-6 border border-gray-300" style={{color: 'black'}}>
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                            <Activity className="w-8 h-8" style={{color: 'black'}} />
                                                        </div>
                                                        <div>
                                                            <h3 className="text-lg font-semibold" style={{color: 'black'}}>Study Streak</h3>
                                                            <p style={{color: 'black'}}>Current days</p>
                                                        </div>
                                                    </div>
                                                    <p className="text-3xl font-bold" style={{color: 'black'}}>
                                                        {(() => {
                                                            const today = new Date().toISOString().split('T')[0];
                                                            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                                                            const hasToday = studySessions.some(s => s.date === today);
                                                            const hasYesterday = studySessions.some(s => s.date === yesterday);
                                                            return hasToday ? (hasYesterday ? '2+' : '1') : '0';
                                                        })()}
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Subject Performance Chart */}
                                            <div className="grid lg:grid-cols-2 gap-6 mb-8">
                                                <div className="bg-white border rounded-xl p-6">
                                                    <div className="flex items-center gap-3 mb-6">
                                                        <BarChart3 className="w-6 h-6 text-blue-600" />
                                                        <h3 className="text-xl font-semibold text-gray-900">Study Time by Subject</h3>
                                                    </div>

                                                    <div className="space-y-4">
                                                        {subjects.map(subject => {
                                                            const subjectTime = studySessions
                                                                .filter(s => s.subjectId === subject.id)
                                                                .reduce((sum, s) => sum + s.duration, 0);
                                                            const totalTime = studySessions.reduce((sum, s) => sum + s.duration, 0);
                                                            const percentage = totalTime > 0 ? (subjectTime / totalTime * 100) : 0;

                                                            return (
                                                                <div key={subject.id} className="space-y-2">
                                                                    <div className="flex items-center justify-between">
                                                                        <div className="flex items-center gap-3">
                                                                            <div 
                                                                                className="w-4 h-4 rounded-full"
                                                                                style={{ backgroundColor: subject.color }}
                                                                            ></div>
                                                                            <span className="font-medium text-gray-900">{subject.name}</span>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <span className="text-sm font-semibold text-gray-900">
                                                                                {Math.floor(subjectTime / 3600)}h {Math.floor((subjectTime % 3600) / 60)}m
                                                                            </span>
                                                                            <span className="text-xs text-gray-500 ml-2">
                                                                                ({percentage.toFixed(1)}%)
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                                                        <div 
                                                                            className="h-3 rounded-full transition-all duration-500"
                                                                            style={{ 
                                                                                width: `${Math.min(percentage, 100)}%`,
                                                                                backgroundColor: subject.color 
                                                                            }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>

                                                <div className="bg-white border rounded-xl p-6">
                                                    <div className="flex items-center gap-3 mb-6">
                                                        <Target className="w-6 h-6 text-green-600" />
                                                        <h3 className="text-xl font-semibold text-gray-900">Goal Achievement</h3>
                                                    </div>

                                                    <div className="space-y-4">
                                                        {subjects.map(subject => {
                                                            const todayTime = studySessions
                                                                .filter(s => s.subjectId === subject.id && s.date === new Date().toISOString().split('T')[0])
                                                                .reduce((sum, s) => sum + s.duration, 0);
                                                            const goalProgress = (todayTime / (subject.goal * 60)) * 100;
                                                            const isGoalMet = goalProgress >= 100;

                                                            return (
                                                                <div key={subject.id} className="space-y-2">
                                                                    <div className="flex items-center justify-between">
                                                                        <div className="flex items-center gap-3">
                                                                            <div 
                                                                                className="w-4 h-4 rounded-full"
                                                                                style={{ backgroundColor: subject.color }}
                                                                            ></div>
                                                                            <span className="font-medium text-gray-900">{subject.name}</span>
                                                                        </div>
                                                                        <div className="flex items-center gap-2">
                                                                            <span className="text-sm font-semibold text-gray-900">
                                                                                {Math.floor(todayTime / 60)}/{subject.goal} min
                                                                            </span>
                                                                            {isGoalMet && <Award className="w-4 h-4 text-yellow-500" />}
                                                                        </div>
                                                                    </div>
                                                                    <div className="w-full bg-gray-200 rounded-full h-3">
                                                                        <div 
                                                                            className={`h-3 rounded-full transition-all duration-500 ${isGoalMet ? 'bg-green-500' : ''}`}
                                                                            style={{ 
                                                                                width: `${Math.min(goalProgress, 100)}%`,
                                                                                backgroundColor: isGoalMet ? '#10b981' : subject.color 
                                                                            }}
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Recent Activity and Trends */}
                                            <div className="grid lg:grid-cols-2 gap-6 mb-8">
                                                <div className="bg-white border rounded-xl p-6">
                                                    <div className="flex items-center gap-3 mb-6">
                                                        <Activity className="w-6 h-6 text-black" style={{color: 'black', stroke: 'black'}} />
                                                        <h3 className="text-xl font-semibold text-gray-900">Weekly Activity</h3>
                                                    </div>

                                                    <div className="space-y-3">
                                                        {Array.from({length: 7}, (_, i) => {
                                                            const date = new Date();
                                                            date.setDate(date.getDate() - i);
                                                            const dateStr = date.toISOString().split('T')[0];
                                                            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                                                            const dayTime = studySessions
                                                                .filter(s => s.date === dateStr)
                                                                .reduce((sum, s) => sum + s.duration, 0);
                                                            const dayHours = dayTime / 3600;
                                                            const maxHours = 8; // Maximum scale for visualization
                                                            const percentage = Math.min((dayHours / maxHours) * 100, 100);

                                                            return (
                                                                <div key={dateStr} className="flex items-center gap-4">
                                                                    <div className="w-12 text-sm font-medium text-gray-600">
                                                                        {dayName}
                                                                    </div>
                                                                    <div className="flex-1">
                                                                        <div className="w-full bg-gray-200 rounded-full h-6">
                                                                            <div 
                                                                                className="bg-blue-600 h-6 rounded-full flex items-center px-2 transition-all duration-500"
                                                                                style={{ width: `${Math.max(percentage, dayTime > 0 ? 20 : 0)}%` }}
                                                                            >
                                                                                {dayTime > 0 && (
                                                                                    <span className="text-xs font-medium text-white">
                                                                                        {Math.floor(dayTime / 3600)}h {Math.floor((dayTime % 3600) / 60)}m
                                                                                    </span>
                                                                                )}
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div className="w-16 text-right text-sm text-gray-500">
                                                                        {date.getDate()}/{date.getMonth() + 1}
                                                                    </div>
                                                                </div>
                                                            );
                                                        }).reverse()}
                                                    </div>
                                                </div>

                                                <div className="bg-white border rounded-xl p-6">
                                                    <div className="flex items-center gap-3 mb-6">
                                                        <TrendingUp className="w-6 h-6 text-orange-600" />
                                                        <h3 className="text-xl font-semibold text-gray-900">Study Insights</h3>
                                                    </div>

                                                    <div className="space-y-4">
                                                        <div className="p-4 bg-gray-200 rounded-lg">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                                    <Clock className="w-4 h-4 text-black" style={{color: 'black', stroke: 'black'}} />
                                                                </div>
                                                                <span className="font-medium" style={{color: 'black'}}>Most Productive Subject</span>
                                                            </div>
                                                            <p style={{color: 'black'}}>
                                                                {(() => {
                                                                    const subjectTimes = subjects.map(subject => ({
                                                                        name: subject.name,
                                                                        time: studySessions
                                                                            .filter(s => s.subjectId === subject.id)
                                                                            .reduce((sum, s) => sum + s.duration, 0)
                                                                    }));
                                                                    const mostStudied = subjectTimes.reduce((max, current) => 
                                                                        current.time > max.time ? current : max, subjectTimes[0] || {name: 'None', time: 0}
                                                                    );
                                                                    return mostStudied.time > 0 ? `${mostStudied.name} (${Math.floor(mostStudied.time / 3600)}h ${Math.floor((mostStudied.time % 3600) / 60)}m)` : 'No data yet';
                                                                })()}
                                                            </p>
                                                        </div>

                                                        <div className="p-4 bg-gray-200 rounded-lg">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                                    <Target className="w-4 h-4 text-black" style={{color: 'black', stroke: 'black'}} />
                                                                </div>
                                                                <span className="font-medium" style={{color: 'black'}}>Goals Achieved Today</span>
                                                            </div>
                                                            <p style={{color: 'black'}}>
                                                                {(() => {
                                                                    const today = new Date().toISOString().split('T')[0];
                                                                    const goalsAchieved = subjects.filter(subject => {
                                                                        const todayTime = studySessions
                                                                            .filter(s => s.subjectId === subject.id && s.date === today)
                                                                            .reduce((sum, s) => sum + s.duration, 0);
                                                                        return todayTime >= subject.goal * 60;
                                                                    }).length;
                                                                    return `${goalsAchieved} of ${subjects.length} subjects`;
                                                                })()}
                                                            </p>
                                                        </div>

                                                        <div className="p-4 bg-gray-200 rounded-lg">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                                    <Award className="w-4 h-4 text-black" style={{color: 'black', stroke: 'black'}} />
                                                                </div>
                                                                <span className="font-medium" style={{color: 'black'}}>Longest Session</span>
                                                            </div>
                                                            <p style={{color: 'black'}}>
                                                                {(() => {
                                                                    const longestSession = studySessions.reduce((max, current) => 
                                                                        current.duration > max.duration ? current : max, 
                                                                        studySessions[0] || {duration: 0, subjectId: null}
                                                                    );
                                                                    const subject = subjects.find(s => s.id === longestSession.subjectId);
                                                                    return longestSession.duration > 0 ? 
                                                                        `${Math.floor(longestSession.duration / 3600)}h ${Math.floor((longestSession.duration % 3600) / 60)}m in ${subject?.name || 'Unknown'}` : 
                                                                        'No sessions yet';
                                                                })()}
                                                            </p>
                                                        </div>

                                                        <div className="p-4 bg-gray-200 rounded-lg">
                                                            <div className="flex items-center gap-2 mb-2">
                                                                <div className="w-12 h-12 bg-white rounded-lg flex items-center justify-center">
                                                                    <Activity className="w-4 h-4 text-black" style={{color: 'black', stroke: 'black'}} />
                                                                </div>
                                                                <span className="font-medium" style={{color: 'black'}}>Weekly Average</span>
                                                            </div>
                                                            <p style={{color: 'black'}}>
                                                                {(() => {
                                                                    const today = new Date();
                                                                    const weekStart = new Date(today.setDate(today.getDate() - 7)); // Start of the week (7 days ago)
                                                                    const weekStartStr = weekStart.toISOString().split('T')[0];
                                                                    const weekSessions = studySessions.filter(s => s.date >= weekStartStr);
                                                                    const weekTime = weekSessions.reduce((sum, s) => sum + s.duration, 0);
                                                                    const dailyAvg = weekTime / 7; // Average over 7 days
                                                                    return `${Math.floor(dailyAvg / 3600)}h ${Math.floor((dailyAvg % 3600) / 60)}m per day`;
                                                                })()}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {currentView === 'video-notes' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-xl p-6 shadow-sm">
                                    <div className="flex items-center justify-between mb-6">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-900">Video Notes</h2>
                                            <p className="text-gray-600">Save important notes alongside YouTube video links for better learning</p>
                                        </div>
                                        <div>
                                            <button
                                                onClick={() => setShowAddVideoNote(true)}
                                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                                            >
                                                <Plus className="w-4 h-4" />
                                                Add Note
                                            </button>
                                        </div>
                                    </div>

                                    {videoNotes.length === 0 ? (
                                        <div className="text-center py-20">
                                            <BookOpen className="w-20 h-20 text-gray-300 mx-auto mb-4" />
                                            <h3 className="text-xl font-semibold text-gray-700 mb-2">No video notes yet</h3>
                                            <p className="text-gray-500 mb-6">Start adding notes and YouTube links to enhance your learning</p>
                                            <button
                                                onClick={() => setShowAddVideoNote(true)}
                                                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                                            >
                                                Add Your First Note
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="grid gap-6">
                                            {videoNotes.map((note) => (
                                                <div key={note.id} className="border rounded-xl p-6 hover:shadow-lg transition-all duration-200 bg-gray-50">
                                                    <div className="flex items-start justify-between mb-4">
                                                        <div className="flex-1">
                                                            <h3 className="text-xl font-bold text-gray-900 mb-2">{note.title}</h3>
                                                            <p className="text-gray-600 mb-4">{note.content}</p>
                                                            {note.videoUrl && (
                                                                <div className="mb-4">
                                                                    <div className="flex items-center gap-2 mb-3">
                                                                        <Play className="w-4 h-4 text-red-600" />
                                                                        <span className="text-sm font-medium text-gray-700">YouTube Video:</span>
                                                                    </div>
                                                                    {getYouTubeEmbedUrl(note.videoUrl) ? (
                                                                        <div className="aspect-video w-full">
                                                                            <iframe
                                                                                width="100%"
                                                                                height="100%"
                                                                                src={getYouTubeEmbedUrl(note.videoUrl)}
                                                                                title="YouTube video player"
                                                                                frameBorder="0"
                                                                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                                                                allowFullScreen
                                                                                className="rounded-lg"
                                                                            ></iframe>
                                                                        </div>
                                                                    ) : (
                                                                        <a 
                                                                            href={note.videoUrl} 
                                                                            target="_blank" 
                                                                            rel="noopener noreferrer"
                                                                            className="text-blue-600 hover:text-blue-800 underline break-all"
                                                                        >
                                                                            {note.videoUrl}
                                                                        </a>
                                                                    )}
                                                                </div>
                                                            )}
                                                            {note.subject && (
                                                                <div className="flex items-center gap-2 mb-2">
                                                                    <div 
                                                                        className="w-4 h-4 rounded"
                                                                        style={{ backgroundColor: note.subject.color }}
                                                                    ></div>
                                                                    <span className="text-sm text-gray-600">Subject: {note.subject.name}</span>
                                                                </div>
                                                            )}
                                                            <div className="text-sm text-gray-500">
                                                                Created: {new Date(note.createdAt).toLocaleDateString()}
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <button 
                                                                onClick={() => deleteVideoNote(note.id)}
                                                                className="p-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors"
                                                                title="Delete Note"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {showAddSubject && (
                            <SubjectForm 
                                onSubmit={addSubject}
                                onCancel={() => setShowAddSubject(false)}
                            />
                        )}

                        {editingSubject && (
                            <SubjectForm 
                                subject={editingSubject}
                                onSubmit={(data) => updateSubject(editingSubject.id, data)}
                                onCancel={() => setEditingSubject(null)}
                            />
                        )}

                        {showAddSession && subjects.length > 0 && (
                            <SessionForm 
                                onSubmit={addSession}
                                onCancel={() => setShowAddSession(false)}
                            />
                        )}

                        {showAddVideoNote && (
                            <VideoNoteForm 
                                onSubmit={addVideoNote}
                                onCancel={() => setShowAddVideoNote(false)}
                            />
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StudyTracker />);
    </script>
</body>
</html>